<div class="property-container">
  @if (!loading && property) {
    <div class="card">
      <img src="https://cdn.flyonui.com/fy-assets/components/card/image-9.png"
           alt="{{ property.title }}"
           class="detail-image" />
      
      <div class="detail-header">
        <h2 class="detail-title">{{ property.title }}</h2>
        <div class="price-tag">
          {{ property.pricePerNight | currency:'HUF':'symbol':'1.0-0' }} <span style="font-size: 0.8rem; font-weight: normal;">/ éj</span>
        </div>
      </div>

      <div class="detail-meta">
        <div class="meta-item">
          <iconify-icon icon="tabler:map-pin" class="text-indigo-600"></iconify-icon>
          <span>{{ property.location }}</span>
        </div>
        <div class="meta-item">
          <iconify-icon icon="tabler:users" class="text-indigo-600"></iconify-icon>
          <span>{{ property.capacity }} fő</span>
        </div>
      </div>

      <div class="detail-description mb-2">
        {{ property.description }}
      </div>
    </div>

    <div class="card mt-6">
      <h3 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2">
        <iconify-icon icon="tabler:messages" class="text-indigo-600"></iconify-icon>
        Vendégek értékelései ({{ comments.length }})
      </h3>

          <div class="mb-8 p-6 bg-indigo-50 rounded-xl">
      @if (authService.isLoggedIn()) {
        <h4 class="text-lg font-semibold text-indigo-900 mb-2">Írd meg a véleményed!</h4>
    
        <div class="flex items-center gap-1 mb-4">
          <span class="text-sm text-indigo-800 font-medium mr-2">Értékelésed:</span>
          @for (star of stars; track star) {
            <button 
              (click)="setRating(star)" 
              class="focus:outline-none transition-transform hover:scale-110">
              <iconify-icon 
                [icon]="star <= newCommentRating ? 'tabler:star-filled' : 'tabler:star'" 
                class="text-2xl"
                [ngClass]="star <= newCommentRating ? 'text-yellow-400' : 'text-indigo-200 hover:text-yellow-200'">
              </iconify-icon>
            </button>
          }
        </div>

        <div class="relative">
          <textarea 
            [(ngModel)]="newCommentText" 
            rows="3" 
            class="w-full p-4 rounded-lg border border-indigo-200 focus:ring-2 focus:ring-indigo-500 outline-none resize-none transition-all"
            placeholder="Milyen volt itt a pihenés? Oszd meg másokkal is...">
          </textarea>
          
          <div class="text-right mt-3">
            <button 
              (click)="submitComment()"
              [disabled]="submittingComment || !newCommentText.trim() || newCommentRating === 0"
              class="bg-indigo-600 hover:bg-indigo-700 disabled:bg-indigo-300 text-white font-medium py-2 px-6 rounded-lg transition-colors shadow-md flex items-center justify-end gap-2 ml-auto">
              @if (submittingComment) { 
                <iconify-icon icon="line-md:loading-loop"></iconify-icon> Küldés... 
              } @else { 
                Értékelés beküldése 
              }
            </button>
            </div>
          </div>
        } @else {
          <div class="text-center py-4">
            <p class="text-gray-600 mb-3">Csak bejelentkezett felhasználók írhatnak értékelést.</p>
            <a routerLink="/login" class="text-indigo-600 font-semibold hover:underline border border-indigo-600 px-5 py-2 rounded-lg hover:bg-indigo-50 transition inline-block">
              Jelentkezz be itt
            </a>
          </div>
        }
      </div>

      <div class="space-y-4">
        @if (comments.length === 0) {
          <div class="text-center py-8 text-gray-500 italic bg-gray-50 rounded-lg border border-dashed border-gray-300">
            Még nem érkezett értékelés ehhez a szálláshoz. Légy te az első!
          </div>
        }

        @for (c of comments; track c.id) {
          <div class="border-b border-gray-100 pb-5 last:border-0 hover:bg-gray-50 p-4 rounded-lg transition-colors relative group">
            <div class="flex justify-between items-start mb-2">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-indigo-100 text-indigo-700 flex items-center justify-center font-bold text-lg shadow-sm">
                  {{ (c.userName || 'V').charAt(0).toUpperCase() }}
                </div>
                <div>
                  <span class="font-semibold text-gray-800">{{ c.userName || 'Vendég' }}</span>
                  <p class="text-xs text-gray-400">{{ c.createdAt | date:'medium' }}</p>
                </div>
              </div>
              
              <div class="flex items-center gap-2">
                
                @if (authService.isLoggedIn()) {
                  <button 
                    (click)="toggleCommentLike(c.id)"
                    class="p-2 transition-colors rounded-full flex items-center gap-1"
                    [ngClass]="likedCommentIds.has(c.id) ? 'text-blue-600 bg-blue-50' : 'text-gray-400 hover:text-blue-500 hover:bg-gray-100'"
                    title="Hasznos vélemény">
                    <iconify-icon 
                      [icon]="likedCommentIds.has(c.id) ? 'tabler:thumb-up-filled' : 'tabler:thumb-up'" 
                      width="20">
                    </iconify-icon>
                  </button>
                }

                @if (authService.getUserIdFromToken() === c.userId || authService.getRoleFromToken() === 'Admin') {
                  <button 
                    (click)="deleteComment(c.id)" 
                    class="text-red-400 hover:text-red-600 hover:bg-red-50 p-2 rounded-full opacity-0 group-hover:opacity-100 transition-all"
                    title="Komment törlése">
                    <iconify-icon icon="tabler:trash" width="20"></iconify-icon>
                  </button>
                }
              </div>
            </div>
            
            <p class="text-gray-700 leading-relaxed pl-13 mt-1">{{ c.content }}</p>
          </div>
        }
      </div>
    </div>

    <div class="mt-6 text-center">
      <button (click)="goBack()" class="btn btn-secondary">
        <iconify-icon icon="tabler:arrow-left"></iconify-icon>
        Vissza a listához
      </button>
    </div>
  } 
  
  @else if (loading) {
    <div class="state-message">
      <iconify-icon icon="line-md:loading-loop" width="40"></iconify-icon>
      <p>Betöltés...</p>
    </div>
  }
</div>